#: kivy 1.10.0


AttractorGame:


<AttractorGame>:
    id: game
    gameworld: gameworld

    GameWorld:
        id: gameworld
        gamescreenmanager: gamescreenmanager
        size_of_gameworld: 200 * 1024
        zones: {'general': 20000, 'touch': 1000}
        system_count: 11

        PositionSystem2D:
            system_id: 'position'
            gameworld: gameworld
            zones: ['general', 'touch']

        RotateSystem2D:
            system_id: 'rotate'
            gameworld: gameworld
            zones: ['general']

        CymunkPhysics:
            id: cymunk_physics
            system_id: 'cymunk_physics'
            gameworld: gameworld
            zones: ['general']

        AnimationSystem:
            id: animation
            system_id: 'animation'
            gameworld: gameworld
            updateable: True
            zones: ['general']

        RotateRenderer:
            id: rotate_renderer
            system_id: 'rotate_renderer'
            gameworld: gameworld
            frame_count: 2
            updateable: True
            force_update: False
            gameview: 'play_camera'
            shader_source: 'resources/shaders/p_r_shader.glsl'
            zones: ['general']

        GameMap:
            id: gamemap
            gameworld: gameworld
            map_size: 100 * 40, 100 * 40
            zones: ['general']

        GameView:
            id: play_camera
            system_id: 'play_camera'
            gameworld: gameworld
            currentmap: gamemap
            camera_scale: 1
            size: root.size
            window_size: root.size
            pos: root.pos
            updateable: True
            do_scroll: True
            do_scroll_lock: False
            focus_entity: True
            entity_to_focus: game.attractor_id
            touch_pass_through: True
            zones: ['general']

        ChargeSystem:
            system_id: 'charge'
            gameworld: gameworld
            zones: ['general']
            updateable: True

        PoleChangerSystem:
            system_id: 'pole_changer'
            gameworld: gameworld
            zones: ['general']
            updateable: True

        FinishSystem:
            system_id: 'finish'
            gameworld: gameworld
            zones: ['general']
            updateable: True

        LevelEditorSystem:
            system_id: 'editor'
            gameworld: gameworld
            zones: ['general']
            updateable: True

    GameScreenManager:
        id: gamescreenmanager
        gameworld: gameworld
        size: root.size
        pos: root.pos


<GameScreenManager>:
    MenuScreen:
        id: menu_screen

    PlayScreen:
        id: play_screen

    EditorScreen:
        id: editor_screen

    LevelSelectScreen:
        id: level_select_screen


<MenuScreen@GameScreen>:
    name: 'menu_screen'

    BoxLayout:
        orientation: 'vertical'
        padding: 10
        spacing: 10
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        size_hint: 0.2, 0.15

        Button:
            text: 'Levels'
            on_release: app.game.go_to_level_select_screen()

        Button:
            text: 'Editor'
            on_release: app.game.go_to_editor_screen()


<LevelSelectScreen@GameScreen>:
    name: 'level_select_screen'

    ScrollView:
        id: scroll
        size_hint: 0.3, 0.7
        do_scroll_x: False
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}

        BoxLayout:
            id: buttons
            orientation: 'vertical'
            padding: 10
            spacing: 10
            size_hint: 1, None


<PlayScreen@GameScreen>:
    name: 'play_screen'
    id: scr

    canvas:
        #:set alpha 0.25
        #:set w 10

        # Red
        Color:
            rgba: 0.894, 0.243, 0.282, alpha
        
        Line:
            width: w
            points: [0.3 * scr.width, 0, 0, 0, 0, scr.height, 0.3 * scr.width, scr.height]
            
        # Gray
        Color:
            rgba: 0.314, 0.376, 0.412, alpha
        
        Line:
            width: w
            points: [0.325 * scr.width, 0, (1 - 0.325) * scr.width, 0]
        
        Line:
            width: w
            points: [0.325 * scr.width, scr.height, (1 - 0.325) * scr.width, scr.height]
        
        # Blue
        Color:
            rgba: 0.118, 0.490, 0.694, alpha
        
        Line:
            width: w
            points: [(1 - 0.3) * scr.width, 0, scr.width, 0, scr.width, scr.height, (1 - 0.3) * scr.width, scr.height]

    Button:
        size_hint: 0.15, 0.04
        pos: 0, self.parent.height - self.height
        text: "Menu"
        on_release: app.game.go_to_menu_screen()

    Button:
        size_hint: 0.15, 0.04
        pos: self.parent.width - self.width, self.parent.height - self.height
        text: "Reset"
        on_release: app.game.reset_attractor()

    BoxLayout:
        orientation: 'horizontal'
        size_hint_y: 0.95
        padding: 1
        spacing: 1

        Button:
            on_press: app.game.change_attractor_charge(self, '+')
            background_color: [1, 0.4, 0.4, 0.]
            background_normal: ''
        Button:
            on_press: app.game.change_attractor_charge(self, 'n')
            background_color: [0.4, 0.4, 0.4, 0.]
            background_normal: ''
        Button:
            on_press: app.game.change_attractor_charge(self, '-')
            background_color: [0.4, 0.4, 1, 0.]
            background_normal: ''

<EditorScreen@GameScreen>:
    name: 'editor_screen'

    Button:
        size_hint: 0.1, 0.035
        pos: 0, self.parent.height - self.height
        text: "Menu"
        on_release: app.game.go_to_menu_screen()

    Button:
        size_hint: 0.1, 0.035
        pos: self.parent.width/2 - self.width, self.parent.height - self.height
        text: "Clear"
        on_release: app.game.clear_level()

    Button:
        size_hint: 0.1, 0.035
        pos: self.parent.width/2, self.parent.height - self.height
        text: "Redraw"
        on_release: app.game.editor.redraw_anchors()

    Button:
        size_hint: 0.1, 0.035
        pos: self.parent.width - self.width, self.parent.height - self.height
        text: "Reset"
        on_release: app.game.reset_attractor()

    # Grid settings
    BoxLayout:
        id: ui
        padding: 0
        spacing: 0
        size_hint: 1, 0.035
        orientation: 'horizontal'
        pos: 0, 0

        canvas:
            Color:
                rgba: 0.12, 0.12, 0.12, 0.85

            Rectangle:
                size: self.size
                pos: self.pos

        Label:
            text: 'Grid'

        TouchedTextBox:
            id: grid
            text: '10'

        ToggleButton:
            text: 'Delete'
            on_release: app.game.editor.toggle_deleting()

        Label:
            text: 'Level'

        TouchedTextBox:
            id: level_name
            text: ''

        Button:
            text: 'Save'
            on_release: app.game.save_level()

        Button:
            text: 'Load'
            on_release: app.game.load_level()

        Label:
            text: 'Rot'

        TouchedTextBox:
            id: rotation
            text: '0'
            on_text: app.game.update_editor_rotation(self.text)
